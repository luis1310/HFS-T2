name: CI
on: [push, pull_request]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Instalar dependencias del proyecto
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint estricto (algorithms/ y operators/)
        run: |
          pip install flake8 black isort
          # Formateo automático para evitar fallos triviales de estilo
          black tesis3/src
          isort tesis3/src --profile black
          # Verificación de linting
          flake8 tesis3/src/algorithms tesis3/src/operators
      - name: Tests con timeout y cobertura
        run: |
          pip install pytest pytest-timeout pytest-cov
          pytest tesis3/tests -v --timeout=30 --cov=tesis3/src/core --cov=tesis3/src/operators --cov-report=xml --cov-config=.coveragerc_ci
      - name: Gate de cobertura mínima (≥80% core+operators)
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          total_lines = 0
          covered_lines = 0
          targets = ('tesis3/src/core/', 'tesis3/src/operators/')
          # Recorremos todas las clases y filtramos por filename (ruta)
          for cls in root.findall('.//class'):
            filename = cls.get('filename','')
            if filename.startswith(targets):
              lines = cls.find('lines')
              if lines is None:
                continue
              for line in lines.findall('line'):
                total_lines += 1
                hits = line.get('hits','0')
                try:
                  covered = float(hits) > 0.0
                except ValueError:
                  covered = False
                if covered:
                  covered_lines += 1
          cov = (covered_lines / total_lines) if total_lines else 0.0
          assert cov >= 0.80, f'Cobertura {cov*100:.1f}% < 80% (core+operators)'
          PY


